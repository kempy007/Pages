---
title: 'Decoding java-script malware'
date: 2015-01-14T19:04:00.001Z
draft: false
aliases: [ "/2015/01/decoding-java-script-malware.html" ]
parent: Blogger
---
#### date: 2015-01-14

1.0 Purpose
===========

  

This document describes how to decode scripts you may acquire whilst investigating a security incident.

Users may have reported a suspect email that contain a hyperlink.

  

After collecting a few email samples and extracting the URLS, you would normally use an isolated laptop with internet access most likely running linux in a sandbox mode.

  

Use the wget command to fetch the code being served from the collection of URLS you have extracted.

  

Examine collected code and follow redirects to reach the payload server.

  

Normally this payload script will be obfuscated like in the image below;

  

[![](http://3.bp.blogspot.com/-H9iopg_h1pM/VLa70h74k8I/AAAAAAAAI5Q/TlNOupmvH5o/s1600/0.png)](http://3.bp.blogspot.com/-H9iopg_h1pM/VLa70h74k8I/AAAAAAAAI5Q/TlNOupmvH5o/s1600/0.png)

Figure 1 - example of obfuscated java script

2.0 Requirements
================

Latest Firefox Browser with the Firebug extension installed.

[http://jsbeautifier.org/](http://jsbeautifier.org/)

[http://ddecode.com/hexdecoder/](http://ddecode.com/hexdecoder/)

Notepadd++

Possibly winmerge if you want to check if the scripts dynamically change.

  

[](https://www.blogger.com/null)3.0 Procedure
=============================================

Once you’ve found a script that looks obfuscated, the first step is to run it through [http://jsbeautifier.org/](http://jsbeautifier.org/)

All this site does is save you having to manually find the semi colon character and add in the line ends and carriage return to break the script down and make it easier to read. See ‘Figure 2 - beautified code’

  

Copy the beautified script into a new file in notepad++, save this file into your incident working folder with the .html extension. Add in the html and script tags, with the closing tags after the first line of the original beautified script. **!WARNING!**The code within the tag will get executed be careful. In ‘Figure 3 - Edited code in html file’ you can see where I put the html tags. The line that gets executed just defines an array.

  

Now we open firefox and press F12 to open the developer tools and Firebug. Copy the path to your working folder into the address bar of firefox (it will list the contents of the directory), then open/click your file from the list, in my case it is ‘script3.html’

  

Now you can copy in some of the other script lines to find out how it was encoded. We can see that the second line of code is assigning values to an array, We can start to see that the array members name is peppered all over the script and that it’s value should replace the name. See ‘Figure 4 - firefox firebug console’

  

The next few lines keep adding to this array until one line adds a function, then the next line that begins with $.$($.$($.$$ + is where the decoding and then subsequent execution of the script would happen.

  

What we do now because we know $.$ calls an executable function is to omit this, so copy from after the second ( bracket the line. You will get syntax errors so just keep trimming the end of the line until this gets accepted.

  

Now the output of firebug should show lots of hex type code, copy this text and paste onto the site [http://ddecode.com/hexdecoder/](http://ddecode.com/hexdecoder/) this will decode the hex values into plaintext and you should now be able to read what the script is doing and take necessary actions to block the Trojan dropper sites.

  

This particular script decode into nonsense literature excerpts like below;

  

"return"document.write(\\"<p>some star snorting first left</p><p>some little nursing right sure</p><p>creature directions snorting engine kept leave loud</p><p>legs kept straightenin nursing into undoing take this loud grunted</p>\\");"

  

  

But this code could easily be an executable download.

  

  

[![](http://2.bp.blogspot.com/-cL7kYoeD0Tk/VLa700QYdYI/AAAAAAAAI5Y/W12hnlwNf00/s1600/1.png)](http://2.bp.blogspot.com/-cL7kYoeD0Tk/VLa700QYdYI/AAAAAAAAI5Y/W12hnlwNf00/s1600/1.png)

[Figure](https://www.blogger.com/null) 2 - beautified code

  

  

  

[![](http://1.bp.blogspot.com/-p41mY_5eg4o/VLa70-o3vcI/AAAAAAAAI5U/3pt-xi3tq0s/s1600/2.png)](http://1.bp.blogspot.com/-p41mY_5eg4o/VLa70-o3vcI/AAAAAAAAI5U/3pt-xi3tq0s/s1600/2.png)

  

[Figure](https://www.blogger.com/null) 3 - Edited code in html file

  

  

  

[![](http://2.bp.blogspot.com/-cBA3yzeEGWc/VLa72D939rI/AAAAAAAAI5o/CgcoLwo1jNI/s1600/4.png)](http://2.bp.blogspot.com/-cBA3yzeEGWc/VLa72D939rI/AAAAAAAAI5o/CgcoLwo1jNI/s1600/4.png)

  

[Figure](https://www.blogger.com/null) 4 - firefox firebug console

  

  

  

[![](http://3.bp.blogspot.com/-GO1dgP6vnzA/VLa71rdhGJI/AAAAAAAAI5k/5i81ys4jKZA/s1600/3.png)](http://3.bp.blogspot.com/-GO1dgP6vnzA/VLa71rdhGJI/AAAAAAAAI5k/5i81ys4jKZA/s1600/3.png)

Figure 5 - firebug decoded to hex values

  

  

  

[![](http://2.bp.blogspot.com/-gNYKth3jk_k/VLa72uBbTvI/AAAAAAAAI5w/VDtgjjDgrYU/s1600/6.png)](http://2.bp.blogspot.com/-gNYKth3jk_k/VLa72uBbTvI/AAAAAAAAI5w/VDtgjjDgrYU/s1600/6.png)

  

Figure 6 - online hex decode site